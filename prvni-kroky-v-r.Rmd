---
title: "Instalace, nastavení a první krůčky v R"
author: "Marek Prokop"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Instalace R a RStudia

Potřebujete dvě věci: samotné R, které je hodně spartánské a pracuje se v něm blbě, a RStudio, které je naopak super komfortní a když ho máte, do základního R už nikdy nevlezete.

### Cloud nebo instalace

Dobrá zpráva: pokud nechcete, nic si instalovat nemusíte. Pro první pokusy i pro vážnější práci můžete použít [RStudio.cloud](https://rstudio.cloud/), které běží v prohlížeči.

Život s ním budete mít o dost jednodušší, ale peněženku o něco prázdnější. RStudio.cloud sice má variantu zdarma, ale v té můžete pracovat maximálně 15 hodin měsíčně (za 5 USD 50 hodin měsíčně) a dostanete jen 1 GB RAM a 1 CPU, což není mnoho. Použitelná verze vás pak bude stát od 25 USD (small business) a dostanete 160 hodin měsíčně, až 8 GB RAM a až 4 CPU. Hodiny se ale násobí počtem CPU a velikostí RAM.

Jestli v cloudu pracovat nechcete, musíte nainstalovat jednak R a jednak RStudio. Obojí je snadné a zdarma. Pro vážnější práci budete časem potřebovat ještě Git. Ten je taky zdarma, ale rozchodit ho nemusí být úplně triviální.

**Moje doporučení:** jestli chcete R jen nezávazně vyzkoušet, zvlote cloud. Instalovat můžete kdykoli později.

### Instalace R

Stáhněte a nainstalujte si zkompilovanou verzi R pro svůj operační sytém z <https://cloud.r-project.org/>. Žádná past by tam být neměla, postupujte podle instrukcí na webu a v instalátoru.

Když po instalaci R spustíte, mělo by vypadat nějak takhle:

![Základní R po spuštění](img/r-01.png)

Okno zavřete a to je všechno. Odtěď můžete na základní R zapomenout.

### Instalace RStudia

Stáhněte a nainstalujte si RStudio Desktop z <https://www.rstudio.com/products/rstudio/download/>. I to by mělo jít bez problémů a spuštěné RStudio pak bude vypadat nějak takto:

![RStudio po prvním spuštění](img/rstudio-01.png)

### Pokud už R a RStudio máte (a trochu znáte)

Pro jistotu si zkontrolujte verzi RStudia i R. Verzi R vám řekne konsole při spuštění a kdykoli později ji zjistíte příkazem:

```{r}
R.version.string
```

Poslední verze (zjistíte [na webu R](https://www.r-project.org/)) je nejlepší, ale když budete o pár desetinek pozadu, nic vážného se nestane. On je upgrade R malinko opruz, takže ho nechcete dělat zbytečně. Rozhodně si ale aktualizujte nainstalované balíčky, protože to jde snadno příkazem:

```{r eval=FALSE}
update.packages(ask = FALSE, checkBuilt = TRUE)
```

Pokud byste měli starou verzi RStudia, jde ho normálně přeinstalovat.

## Založte si cvičný projekt

Tohle fakt hned teď udělejte. Je to důležité.

Po spuštění RStudia zvolte příkaz *New Project…* z menu *File*, nebo z roletky projektů vpravo nahoře. Na další obrazovce zvolte *New Directory*.

![Dialog Create Project](img/rstudio-project-01.png)

Na další *New Project*.

![Volba typu projektu](img/rstudio-project-02.png)

A nakonec zadejte název složky, ve které se má projekt vytvořit. Může to být výchozí (domovská) složka pro R (~/R) nebo jakákoli jiná, kterou si vytvoříte jako nadřízenou složku pro podložky eRkových projektů. Třeba u mě to je `c:/dev/R` (pro moje projekty), nebo `c:/dev/R/clients` (pro klientské projekty).

![Volba složky projektu](img/rstudio-project-03.png)

### Co jsou projekty

V RStudiu se nejčastěji pracuje v tzv. projektech. Jde to sice i bez nich, ale projekty jsou praktické, protože si pamatují různá nastavení, poslední otevřené soubory, historii příkazů apod. Na vašem počítači jeden projekt vždy odpovídá jedné složce (s případnými podsložkami), do které si RStudio uloží projektový soubor `nazev-projektu.Rproj`. Tímto souborem jde pak projekt otevřít např. z Průzkumníka Windows.

K projektům ještě pár doporučení a vysvětlení:

- V některých situacích vám zjednoduší život, když budete projekty pojmenovávat podobně jako webová URL, tj. jen písmeny malé anglické abecedy, čísly, pomlčkami a tečkami. Nutné to ale není.
- Po standardní instalaci vám na Windows (jinde to může být jiné) ve složce Dokumenty vznikne podsložka R, kterou pak RStudio (i samotné R) označuje aliasem ~/R. Projekty ale můžete zakládat i jinde.
- Ať už si projekt založíte kdekoli, doporučuji si pro všechny projekty zvolit jedinou zastřešující složku, protože v různých kontextech se vám pak zobrazí jen název projektu, a pokud byste na více místech měli stejně pojmenované projekty, pletlo by vás to.
- Pokud máte nebo až budete mít zprovozněný Git, objeví se vám při volbě složky i volba *Create a git repository*. Vždycky ji zapínejte. Pro první pokusy ale Git nepotřebujete.

## Nastavení RStudia

R i RStudio je ve výchozím stavu nastaveno v zásadě dobře. Změňte prosím jen dvě věci.

Z menu *Tools* vyberte příkaz *Global Options…* (úplně na konci) a v následujícím dialogu vypněte volbu *Restore .RData into workspace at startup* a volbu *Save workspace to .RData on exit* nastavte na *Never*.

![RStudio: Options - General](img/rstudio-options-01.png)

A pak na panelu *Code* zapněte volbu *Use native pipe operator*. To sice není nutné, ale vše se pak bude chovat stejně, jako v mých ukázkách.

![RStudio: Options - Code](img/rstudio-options-02.png)

## Instalace balíčků

Základní R je jenom jazykové jádro s nezbytnými příkazy a funkcemi. Jeho funkčnost rozšiřují tzv. balíčky (packages), kterým se v jiných jazycích často říká knihovny. Balíčky je potřeba jednak nainstalovat (jednorázově) a jednak připojit před konkrétní prací, ke které je potřebujete (vysvětlím později).

V RStudiu Desktop už jsou některé balíčky předinstalované a ještě víc jich je v cloudovém RStudio, ale pro jistotu vám ukážu, jak nainstalujete ty, které budete potřebovat pro celý tenhle seriál.

Z menu *Tools* zvolte příkaz *Install Packages…*. Objeví se tento dialog:

![Dialog Install Packages](img/install-packages-01.png)

Nechte v něm předvyplněné volby a do prázdného políčka vložte tento seznam balíčků:

```
janitor, knitr, lubridate, rmarkdown, readxl, rvest, tidyverse
```

Alternativně jde balíčky instalovat funkcí `install.packages()`, kterou zavoláte třeba z konsole (vysvětlím za chvíli). To pak vypadá takhle:

```{r eval=FALSE}
install.packages(c("janitor", "knitr", "lubridate", "rmarkdown", "readxl", "rvest", "tidyverse"))
```

Oba způsoby balíčky zároveň aktualizují, což se občas hodí.


## Tři způsoby práce s R

S R jde pracovat mnoha různými způsoby. Já nejčastěji používám tři:

1. Interaktivní práce v konsoli.
1. Polointeraktivní práce se skriptem.
1. Interaktivní, poloautomatická či zcela automatická tvorba dokumentu v R Markdownu.

Všechny tři ukážu na jednoduchém příkladu: představte si, že jste dnes ve svém obchodě vydali 100 účtenek. Teď se chcete rychle dozvědět, kolik dělá celková tržba a jaká byla typická útrata jednoho zákazníka.

### Interaktivní práce s konsolí

Vaše RStudio vypadá nějak takhle a konsole je ta velká plocha vlevo. Psát budete za zobáček úplně vlevo (jinam ani nejde umístit kursor), každý řádek vždy odentrujete a konsole vám většinou nějak odpoví.

![RStudio: Console](img/rstudio-console-01.png)

Nejprve si vygenerujte účtenky. Budou sice trochu falešné, ale to nevadí. Do konsole napište:

```{r}
cena <- round(rnorm(n = 100, mean = 1000, sd = 200), digits = 2)
```

Odentrujte a nic se nestane. Vlastně stane. Pokud se podíváte doprava na záložku *Environment*, uvidíte tam tohle:

![RStudio: Výsledek přiřazení](img/rstudio-console-02.png)

Příkazem jste totiž vytvořili v prostředí R (environment) nový objekt `cena` a uložili jste do něj sto (skoro) náhodných čísel. Na všechny se můžete podívat příkazem:

```{r}
cena
```

což pak na konsoli vypadá nějak takhle:

![Výsledek příkazu cena](img/rstudio-console-03.png)

Teď vám to ale musím vysvětlit trochu podrobněji.

#### Objekty (proměnné)

Objekt jazyka R se chová podobně jako proměnná v jiných programovacích jazycích. Je to vlastně takový šuplík, do kterého si můžete ukládat nejrůznější hodnoty: čísla, textové řetězce, logické hodnoty (TRUE a FALSE čili pravda a nepravda) apod.

Oproti jiným programovacím jazykům je tu pár zvláštností:

- Do objektů se přiřazuje znaky `<-` ale můžete si to zjednodušit klávesovou zkratkou <kbd>Alt</kbd>+<kbd>-</kbd> (Alt pomlčka).
- Běžné objekty R jsou ve skutečnosti vektory. V jiných programovacích jazycích tomu obvykle odpovídá jednorozměrné pole. V praxi to znamená, že v číselném objektu nemusí být jen jedno číslo, ale může jich tam být moc. V našem příkladu jich je sto.
- R s vektory automaticky i počítá. K vektoru pěti čísel tedy můžete přičíst jedno číslo (ve skutečnosti vektor s jedním číslem) a ono se automaticky přičte ke všem pěti.

Kde se nám tam těch sto čísel vzalo? Získali jsme je funkcemi rnorm a round.

#### Funkce

Poučka praví, že když to existuje, je to objekt, a když to něco dělá, je to funkce. Můžete to brát i tak, že funkce je všechno, co má za svým jménem kulaté závorky. V závorkách mohou být tzv. parametry (někdy se jim říká argumenty; je to totéž), čili vstupní data, která chcete funkci předat. Funkce tyto parametry nějak zpracuje a vrátí výsledek. Vlastně úplně stejně, jako funkce v Excelu.

U názvů objektů i funkcí záleží na velikosti písmen. `Cena` je něco jiného než `cena`, tak pozor na to.

`rnorm` je funkce, která vrací (skoro) náhodná čísla. Skoro jsem dal do závorky, protože vrácená čísla jsou náhodná v rámci normálního rozdělení (to je ta slavná Gaussova křivka), jehož podobu určíte parametry `mean` (průměr) a `sd` (směrodatná odchylka neboli standard deviation). Parametrem `n` navíc musíte určit, kolik těch čísel vlastně chcete.

Následující příkaz tedy vrátí vektor sta náhodných čísel z normální rozdělení s průměrem 1000 a směrodatnou odchylkou 200.

```{r}
rnorm(n = 100, mean = 1000, sd = 200)
```

Klidně si ho zadejte párkrát do konzole s různými parametry, abyste viděli, jak se mění výsledek.

`round`` je funkce, která zaokrouhluje. První parametr je číselný vektor, který se má zaokrouhlit, a druhý parametr digits určuje, na kolik desetinných míst se má zaokrouhlit. Následující příkaz tedy zaokrouhlí číslo 1.145 na dvě desetinná místa:

```{r}
round(1.145, digits = 2)
```

První parametr funkce `round` se jmenuje `x`, ale první parametr funkce se často píše bez jména, protože jeho pořadí nejde poplést. Každopádně ale může napsat volání funkce i takto a výsledk bude stejný:

```{r}
round(x = 1.145, digits = 2)
```

A teď už asi chápete – funkce `rnorm` vrátí sto čísel s hodně desetinnými čísly, a proto jste její výsledek ještě poslali funkci `round`, která celý vektor (tj. všech sto čísel) zaokrouhlila na dvě desetinná místa. V jiném programovacím jazyce byste na to potřebovali dost složité výpočty v cyklech, v R stačí tohle:

```{r}
round(rnorm(n = 100, mean = 1000, sd = 200), digits = 2)
```

Mimochodem, všimli jste si v předešlých příkladech těch čísel v hranatých závorkách? Protože se v příkladech vypisují jako výsledky vektory (všechny základní, tzv. atomické typy jsou v R vektory), R vám těmi čísly v hranatých závorkách říká, na jaké pozici ve vektoru daná hodnota je.

A hranaté závorky jdou i použít pro adresování konkrétního prvku vektoru. Třeba tohle zobrazí z vytvořeného vektoru `cena` jenom pátý prvek:

```{r}
cena[5]
```

a tohle pátý až desátý:

```{r}
cena[5:10]
```

Chtěli jsme ještě účtenky sečíst, že? Je to hračka:

```{r}
sum(cena)
```

Zajímá vás, kolik dělá celková tržba bez DPH?

```{r}
sum(cena / 121 * 100)
```

případně:

```{r}
sum(cena) / 121 * 100
```

Obojí by vám mělo dát stejný výsledek. V prvním případě se ale nejprve vydělí každý jednotlivý prvek vektoru a pak se celý vektor sečte, kdežto v druhém případě se celý vektor nejprve sečte a pak teprve vydělí.

Zajímá vás rozložení ceny zobrazené v histogramu?

```{r}
hist(cena)
```

Zobrazí se vám na panelu *Plot* vpravo (váš bude vypadat trochu jinak).

Tím jste poznali další dvě funkce (`sum` a `hist`). Teď vám ukážu, jak totéž udělat skriptem a v R Markdown.

### Práce se skripty

Práce v konsoli je sice flexibilní, ale na víc než pár příkazů dost nepraktická. Když uděláte chybu, můžete se sice šipkami nahoru a dolů pohybovat po historii příkazů a opravovat je, ale není to ono. Chyby se mnohem lépe opravují ve skriptech.

Z menu *File → New File* vyberte *R Script* a vlevo nahoře se vám otevře editor skriptů. Do něj si vložte všechny příkazy, které jste předtím zadali postupně do konsole. Nemusíte to ale dělat ručně – podívejte se vpravo na záložku History a vida, jsou tam, že? Vyberte ty správné a tlačítkem To Source je přesuňte do skriptu. Okno RStudia by pam mělo vypadat nějak takto:

![Skript v RStudiu](img/rstudio-script-01.png)



Když nyní na kterémkoli řádku stisknete <kbd>Ctrl</kbd>+<kbd>Enter</kbd>, celý řádek se vykoná stejně, jako kdybyste ho zadali na konzoli. Můžete i klávesou Shift vybrat víc řádků a pak se po <kbd>Ctrl</kbd>+<kbd>Enter</kbd> vykonají všechny. A konečně můžete tlačítkem *Source* nad editorem vykonat celý skript. Po vykonání celého skriptu by mělo okno RStudia vypadat nějak takto:

![RStudio po vykonání celého skriptu](img/rstudio-script-02.png)

Nezapomeňte si ale celý skript uložit pod nějakým vhodným jménem (třeba `prvni-skript`). Měl by se vám uložit do složky projektu a ke jménu se automaticky připojí přípona R.

#### Úprava skriptu

Hlavní výhoda skriptu spočívá v tom, že jde snadno upravit a pak celý znovu spustit. Vyzkoušejte si to. Hned v prvním řádku změňte `rnorm` za `runif` a odstraňte této funkci parametry `mean` a `sd`, takže zbude jen `n`.

```{r}
cena <- round(runif(n = 100), digits = 2)
```

Když teď celý skript znovu sputíte příkazem *Source* (nebo klávesovou zkratkou <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>S</kbd>), poznáte, co se změnilo?

```{r}
hist(cena)
```

Ano, změnil se histogram. 

Funkce `rnorm` totiž vybírá náhodná čísla z normálního rozložení (**r**andom **norm**al distribution) a histogram má proto tvar známe gaussovy křivky -- čísla blíže průměru se vyskytnou pravděpodobněji než čísla dál od průměru. Funkce `runif` (**r**andom **unif**orm distribution) naproti tomu vybírá náhodná čísla z rovnoměrného rozdělení, takže pravděpodobnost zastoupení všech čísel mezi nulou a jednou je stejná.

### R Markdown

Skripty jsou praktické, ale mají dvě nevýhody: 

- Když nechcete provést celý skript najednou, špatně se v nich hledá část, kterou chcete spustit.
- Výstup není moc přehledný. Textový výstup se ne moc hezky zobrazí v konzoli, grafy na panelu *Plots*.

Obě tyto nevýhody odstraňuje R Markdown.

#### Co je R Markdown

##### Základní Markdown

Samotný [Markdown](https://cs.wikipedia.org/wiki/Markdown) možná znáte. Je to jednoduchý značkovací jazyk, kterým jdou v čistě textovém formátu vyznačit základní strukturání a formátovací prvky -- nadpisy, odstavce, odrážky, odkazy, tučný text apod. Z toho pak jde vygenerovat výstupy v různých formátech: nejčastěji v HTML, ale klidně i PDF, Word atd.

Text v Markdownu vypadá např. takto:

```markdown
# Tohle je nadpis 1. úrovně

Tohle je běžný odstavec. Víc odstavců je od sebe odděleno dvěma Entry čili prázdným řádkem.

## Tohle je nadpis 2. úrovně

Tohle je příklad [odkazu v textu](https://example.com). A tohle je příklad odrážek:

- první odražka,
- druhé odrážka,
- třetí odrážka.

Jdou udělat i číslované body, které se automaticky očíslují podle pořadí:

1. První bod.
1. Druhý bod.
1. Poslední bod.
```

Jak vidíte, docela dobře se píše a dobře se i čte, i když není převedený (vyrenderovaný) do HTML. Ale když se převede, je to výsledek docela hezký:

![Příklad převedeného Mardownu](img/markdown-01.png)

##### R Markdown

R Mardown je Markdown, do kterého jsou zamíchané kusy eRkového kódu. Vypadá nějak takhle:

![Příklad R Markdownu](img/rmarkdown-01.png)

Vyzkoušejte si nyní R Markdown sami. Nejprve si založte nový soubor: Z menu *File → New File* vyberte *R Notebook*. Objeví se vám editor s předvyplněným vzorovým obsahem. Ten celý zrušte (Ctrl+A, Del) a zkopírujte do něj tohle:

````markdown
---
title: "Můj první R Notebook"
output: html_notebook
---

Toto je příklad [R Markdown](http://rmarkdown.rstudio.com) zápisníku (notebook). Začíná nahoře metadaty, které zde udávají jen titulek a formát výstupu. Metadata jsou ohraničena řádky tvořenými třemi pomlčkami. Pak následuje normální Markdown.

Za tímto odstavcem je blok eRkového kódu, kterému se říká *chunk* a já mu budu říkat *blok*.

`r ''````{r}
cena <- round(rnorm(n = 100, mean = 1000, sd = 200), digits = 2)
sum(cena)
`r ''````

Pokud blok spustíte zelenou šipečkou na jeho pravém horním okraji nebo klávesovou zkratkou Ctrl+Shift+Enter, provede se a zobrazí výstup přímo pod sebou.

````

Výsledek bude vypadt jako na předešlém obrázku. Nyní můžete podle instrukcí vykonat jediný blok kódu, který tam zatím máte, a pod blkoem se vám zobrazí součet ceny.

A můžete i celý soubor převést do HTML a prohládnout si ho v celé kráse. Uděláte to příkazem *Preview* z toolbaru nad editorem, ale před tím ještě musíte soubor uložit, třeba pod jménem `prvni-notebook`. Ke jménu se automaticky připojí přípona Rmd.

Celý výsledek se zobrazí v panelu *Viewer* vpravo:

![Náhled vykresleného R Mardownu](img/rmarkdown-02.png)

Už jste pochopili, v čem jsem napsal tenhle článek? Ano, v RStudiu v R Markdownu :-)

Ze všech tří způsobů používání R (konzole, skripty, R Markdown) používám R Markdown pro běžné analýzy nejčastěji. Píšu si v něm postup, eRkový kód i poučení z výsledků. Když se pak později k analýze vrátím, třeba proto, že chci pro jiného klienta udělat nějakou podobnou, krásně vidím, jak jsem postupoval a co a proč jsem udělal. Už tohle je pro mě obrovská výhoda oproti excelové tabulce, ve které se už po pár týdnech nevyznám a musím znovu pracně zkoumat, co tam je, proč to tam a jak to vlastně funguje.

A totéž doporučuji i vám: klidně pro teď zapoměňte, že nějaká konzole a skripty vůbec existují a používejte na všechno R Markdown.

## Co jste se naučili

